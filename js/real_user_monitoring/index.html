<html>
    <head>
        <title>Simple RealUserMonitoring</title>
        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet">
        <style>
            body { font-family: arial }
            table { table-collapse: collapse }
            td {
                border: 1px solid #aaa;
                padding: 5px;
                background: #fff;
            }
            #scorecard {
                width: 350px;
                border: 1px solid grey;
                padding: 5px;
                background: #eee;
            }
            .fa-arrow-circle-o-down { color: green }
            .fa-arrow-circle-o-up { color: red }

            .old { font-size: 9px; }
        </style>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/2.2.1/mustache.min.js"></script>
        <script id="perf-template" type="text/template">
            <table>
                <tr>
                    <td>loadTime</td>
                    <td>{{ loadTime }}</td>
                    <td><i class="fa fa-arrow-circle-o-{{ loadTime_trend }}"></i></td>
                    <td class="old">{{ old_loadTime }}</td>
                </tr>
                 <tr>
                    <td>domContentLoaded</td>
                    <td>{{ domContentLoaded }}</td>
                    <td><i class="fa fa-arrow-circle-o-{{ domContentLoaded_trend }}"></i></td>
                    <td class="old">{{ old_domContentLoaded }}</td>
                </tr>
                <tr>
                    <td>resources</td>
                    <td>{{ resources }}</td>
                    <td><i class="fa fa-arrow-circle-o-{{ resource_trend }}"></i></td>
                    <td class="old">{{ old_resources }}</td>
                </tr>
            </table>
        </script>
    </head>
    <body>
        <h1>RUM - Real User Monitoring</h1>
        <div id='scorecard'>
            <b>Resource-Req.</b><br>
            <sub>FOOBARBAZ</sub>
            <hr>
            <div id="perf-data">

            </div>
        </div>
        <script>
            window.RUMpageId = 'PageIdentifier';
            // window.RUMsendDataTo = '/post/url/'; // or handler-function
            window.RUMsendDataTo = function (data) {
                var storedData = [];

                localStorage.getItem("data")
                    ? storedData = JSON.parse( localStorage.getItem("data") )
                    : localStorage.setItem("data", JSON.stringify( storedData ));

                storedData.push( data );
                localStorage.setItem("data", JSON.stringify( storedData ));
            };

            // totally simple and stupid approach to save, receive and display data
            var perf = {};

            if ( localStorage.getItem("data") ) {
                var storedData = JSON.parse( localStorage.getItem("data") );

                var resources        = 0,
                    loadTime         = 0,
                    domContentLoaded = 0;

                storedData.forEach(function ( entry ) {
                    resources        += entry.resources.length
                    loadTime         += entry.times.loadTime;
                    domContentLoaded += entry.times.domContentLoaded;
                });

                var oldValues;
                if ( localStorage.getItem("perf") ) {
                    oldValues = JSON.parse( localStorage.getItem("perf") );

                    perf.old_resources        = oldValues.resources;
                    perf.old_loadTime         = oldValues.loadTime;
                    perf.old_domContentLoaded = oldValues.domContentLoaded;
                };

                perf.resources        = (resources / storedData.length).toFixed(2);
                perf.loadTime         = (loadTime / storedData.length).toFixed(2);
                perf.domContentLoaded = (domContentLoaded / storedData.length).toFixed(2);

                perf.resource_trend         = perf.old_resources > perf.resources ? 'down' : 'up';
                perf.loadTime_trend         = perf.old_loadTime > perf.loadTime ? 'down' : 'up';
                perf.domContentLoaded_trend = perf.old_domContentLoaded > perf.domContentLoaded ? 'down' : 'up';

                localStorage.setItem("perf", JSON.stringify( perf ));
            }

            var template = document.querySelector( '#perf-template' ).innerHTML,
                html     = Mustache.to_html( template, perf );

            document.querySelector( '#perf-data' ).innerHTML = html;
        </script>
        <script src="rum.js" async></script>
    </body>
</html>
